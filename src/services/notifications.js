// üîî Real-time Notification System
// ÏÉÅÏö©Ìôî ÏàòÏ§ÄÏùò Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º Î∞è Í≤ΩÍ≥† ÏãúÏä§ÌÖú

let nodemailer = null;
try {
  nodemailer = require('nodemailer');
} catch (e) {
  console.log('‚ö†Ô∏è nodemailer not installed - email notifications disabled');
}
const { logger } = require('./monitoring');

/**
 * üìß Ïù¥Î©îÏùº ÏïåÎ¶º ÏÑúÎπÑÏä§
 */
class EmailNotificationService {
  constructor() {
    this.transporter = null;
    this.initializeTransporter();
  }

  initializeTransporter() {
    if (nodemailer && process.env.SMTP_HOST && process.env.SMTP_USER) {
      this.transporter = nodemailer.createTransport({
        host: process.env.SMTP_HOST,
        port: parseInt(process.env.SMTP_PORT) || 587,
        secure: false,
        auth: {
          user: process.env.SMTP_USER,
          pass: process.env.SMTP_PASSWORD,
        },
        tls: {
          rejectUnauthorized: false
        }
      });
      
      console.log('‚úÖ Email notification service initialized');
    } else {
      console.log('‚ö†Ô∏è SMTP configuration missing - email notifications disabled');
    }
  }

  async sendEmail(to, subject, html, priority = 'normal') {
    if (!this.transporter) {
      console.warn('Email transporter not configured');
      return false;
    }

    try {
      const mailOptions = {
        from: `${process.env.FROM_NAME || 'Knowledge Explorer'} <${process.env.FROM_EMAIL}>`,
        to: Array.isArray(to) ? to.join(', ') : to,
        subject,
        html,
        priority: priority === 'high' ? 'high' : 'normal',
      };

      const result = await this.transporter.sendMail(mailOptions);
      
      logger.info('Email sent successfully', {
        type: 'email_notification',
        to: mailOptions.to,
        subject,
        messageId: result.messageId,
        priority,
      });

      return true;
    } catch (error) {
      logger.error('Failed to send email', error, {
        to,
        subject,
        priority,
      });
      return false;
    }
  }

  async sendCriticalAlert(title, message, details = {}) {
    const html = this.generateCriticalAlertTemplate(title, message, details);
    const adminEmails = process.env.ADMIN_EMAILS?.split(',') || [];
    
    if (adminEmails.length > 0) {
      return await this.sendEmail(
        adminEmails,
        `üö® CRITICAL ALERT: ${title}`,
        html,
        'high'
      );
    }
    return false;
  }

  async sendWeeklyReport(data) {
    const html = this.generateWeeklyReportTemplate(data);
    const adminEmails = process.env.ADMIN_EMAILS?.split(',') || [];
    
    if (adminEmails.length > 0) {
      return await this.sendEmail(
        adminEmails,
        `üìä Weekly Analytics Report - ${new Date().toLocaleDateString()}`,
        html
      );
    }
    return false;
  }

  generateCriticalAlertTemplate(title, message, details) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Critical Alert</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .alert { background: #fee; border: 2px solid #f00; padding: 20px; margin: 20px 0; border-radius: 8px; }
          .details { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 15px 0; }
          .timestamp { color: #666; font-size: 0.9em; }
          h1 { color: #d00; }
          h2 { color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
          .severity-critical { background: #ff4444; color: white; padding: 5px 10px; border-radius: 3px; }
        </style>
      </head>
      <body>
        <div class="alert">
          <h1>üö® Critical System Alert</h1>
          <p><span class="severity-critical">CRITICAL</span></p>
          
          <h2>${title}</h2>
          <p>${message}</p>
          
          <div class="details">
            <h3>Details:</h3>
            <ul>
              ${Object.entries(details).map(([key, value]) => 
                `<li><strong>${key}:</strong> ${JSON.stringify(value)}</li>`
              ).join('')}
            </ul>
          </div>
          
          <p class="timestamp">
            <strong>Timestamp:</strong> ${new Date().toISOString()}<br>
            <strong>Environment:</strong> ${process.env.NODE_ENV}<br>
            <strong>Server:</strong> ${process.env.HOSTNAME || 'Unknown'}
          </p>
          
          <p><strong>Action Required:</strong> Please investigate immediately.</p>
        </div>
      </body>
      </html>
    `;
  }

  generateWeeklyReportTemplate(data) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Weekly Report</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .header { background: #4CAF50; color: white; padding: 20px; text-align: center; }
          .metric { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; }
          .metric-value { font-size: 2em; font-weight: bold; color: #4CAF50; }
          .chart-placeholder { background: #eee; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px 0; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üìä Knowledge Explorer - Weekly Report</h1>
          <p>Week of ${new Date().toLocaleDateString()}</p>
        </div>
        
        <div class="metric">
          <h3>üë• User Activity</h3>
          <div class="metric-value">${data.users?.active || 0}</div>
          <p>Active Users (${(data.users?.growth || 0) > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${Math.abs(data.users?.growth || 0)}% from last week)</p>
        </div>
        
        <div class="metric">
          <h3>üí¨ Chat Activity</h3>
          <div class="metric-value">${data.messages?.total || 0}</div>
          <p>Total Messages Sent</p>
        </div>
        
        <div class="metric">
          <h3>üö® System Health</h3>
          <div class="metric-value">${(data.uptime?.percentage || 0).toFixed(2)}%</div>
          <p>Uptime Percentage</p>
        </div>
        
        <div class="metric">
          <h3>‚ö° Performance</h3>
          <div class="metric-value">${(data.performance?.avgResponseTime || 0).toFixed(0)}ms</div>
          <p>Average Response Time</p>
        </div>
        
        <p style="text-align: center; color: #666; margin-top: 40px;">
          Generated automatically by Knowledge Explorer monitoring system
        </p>
      </body>
      </html>
    `;
  }
}

/**
 * üí¨ Slack ÏïåÎ¶º ÏÑúÎπÑÏä§
 */
class SlackNotificationService {
  constructor() {
    this.webhookUrl = process.env.SLACK_WEBHOOK_URL;
    this.enabled = !!this.webhookUrl;
    
    if (this.enabled) {
      console.log('‚úÖ Slack notification service initialized');
    } else {
      console.log('‚ö†Ô∏è Slack webhook URL not configured - Slack notifications disabled');
    }
  }

  async sendMessage(text, options = {}) {
    if (!this.enabled) return false;

    const payload = {
      text,
      username: options.username || 'Knowledge Explorer Bot',
      icon_emoji: options.icon || ':robot_face:',
      channel: options.channel || process.env.SLACK_CHANNEL || '#alerts',
      attachments: options.attachments || [],
      ...options
    };

    try {
      const response = await fetch(this.webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        logger.info('Slack message sent successfully', {
          type: 'slack_notification',
          channel: payload.channel,
          username: payload.username,
        });
        return true;
      } else {
        throw new Error(`Slack API error: ${response.status}`);
      }
    } catch (error) {
      logger.error('Failed to send Slack message', error, {
        text: text.substring(0, 100),
        channel: payload.channel,
      });
      return false;
    }
  }

  async sendAlert(level, title, message, details = {}) {
    const colors = {
      info: '#36a64f',    // ÎÖπÏÉâ
      warning: '#ff9900',  // Ï£ºÌô©ÏÉâ
      error: '#ff0000',   // Îπ®Í∞ÑÏÉâ
      critical: '#8B0000' // ÏßÑÌïú Îπ®Í∞ÑÏÉâ
    };

    const icons = {
      info: ':information_source:',
      warning: ':warning:',
      error: ':x:',
      critical: ':rotating_light:'
    };

    const attachment = {
      color: colors[level] || colors.info,
      title: `${icons[level]} ${title}`,
      text: message,
      fields: Object.entries(details).map(([key, value]) => ({
        title: key,
        value: typeof value === 'object' ? JSON.stringify(value) : String(value),
        short: true
      })),
      footer: 'Knowledge Explorer Monitoring',
      ts: Math.floor(Date.now() / 1000)
    };

    return await this.sendMessage('', {
      attachments: [attachment],
      channel: level === 'critical' ? '#critical-alerts' : '#alerts'
    });
  }

  async sendDeploymentNotification(environment, version, status) {
    const color = status === 'success' ? '#36a64f' : '#ff0000';
    const icon = status === 'success' ? ':white_check_mark:' : ':x:';
    
    const attachment = {
      color,
      title: `${icon} Deployment ${status === 'success' ? 'Successful' : 'Failed'}`,
      fields: [
        { title: 'Environment', value: environment, short: true },
        { title: 'Version', value: version, short: true },
        { title: 'Status', value: status, short: true },
        { title: 'Time', value: new Date().toISOString(), short: true }
      ],
      footer: 'CI/CD Pipeline',
      ts: Math.floor(Date.now() / 1000)
    };

    return await this.sendMessage('', {
      attachments: [attachment],
      channel: '#deployments'
    });
  }

  async sendMetricsUpdate(metrics) {
    const attachment = {
      color: '#439FE0',
      title: ':chart_with_upwards_trend: Real-time Metrics Update',
      fields: [
        { title: 'Active Users', value: metrics.activeUsers || 0, short: true },
        { title: 'Messages/Hour', value: metrics.messagesPerHour || 0, short: true },
        { title: 'Avg Response Time', value: `${metrics.avgResponseTime || 0}ms`, short: true },
        { title: 'Error Rate', value: `${(metrics.errorRate || 0).toFixed(2)}%`, short: true },
      ],
      footer: 'Hourly Metrics Report',
      ts: Math.floor(Date.now() / 1000)
    };

    return await this.sendMessage('', {
      attachments: [attachment],
      channel: '#metrics'
    });
  }
}

/**
 * üîî ÌÜµÌï© ÏïåÎ¶º Í¥ÄÎ¶¨Ïûê
 */
class NotificationManager {
  constructor() {
    this.emailService = new EmailNotificationService();
    this.slackService = new SlackNotificationService();
    this.alertRules = new Map();
    this.alertCooldowns = new Map();
    this.setupDefaultRules();
  }

  /**
   * Í∏∞Î≥∏ ÏïåÎ¶º Í∑úÏπô ÏÑ§Ï†ï
   */
  setupDefaultRules() {
    // ÏóêÎü¨Ïú® ÏûÑÍ≥ÑÏπò
    this.addAlertRule('error_rate', {
      condition: (value) => value > 5, // 5% Ïù¥ÏÉÅ
      cooldown: 300000, // 5Î∂Ñ
      level: 'warning',
      message: 'Error rate is above threshold'
    });

    // ÏùëÎãµ ÏãúÍ∞Ñ ÏûÑÍ≥ÑÏπò
    this.addAlertRule('response_time', {
      condition: (value) => value > 3000, // 3Ï¥à Ïù¥ÏÉÅ
      cooldown: 600000, // 10Î∂Ñ
      level: 'warning',
      message: 'Response time is above threshold'
    });

    // Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ ÏûÑÍ≥ÑÏπò
    this.addAlertRule('memory_usage', {
      condition: (value) => value > 90, // 90% Ïù¥ÏÉÅ
      cooldown: 300000, // 5Î∂Ñ
      level: 'error',
      message: 'Memory usage is critically high'
    });

    // ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Îüâ ÏûÑÍ≥ÑÏπò
    this.addAlertRule('disk_usage', {
      condition: (value) => value > 85, // 85% Ïù¥ÏÉÅ
      cooldown: 3600000, // 1ÏãúÍ∞Ñ
      level: 'warning',
      message: 'Disk usage is high'
    });
  }

  /**
   * ÏïåÎ¶º Í∑úÏπô Ï∂îÍ∞Ä
   */
  addAlertRule(name, rule) {
    this.alertRules.set(name, rule);
  }

  /**
   * Î©îÌä∏Î¶≠ Í∞í ÌôïÏù∏ Î∞è ÏïåÎ¶º
   */
  async checkMetricAndAlert(metricName, value, context = {}) {
    const rule = this.alertRules.get(metricName);
    if (!rule || !rule.condition(value)) return false;

    // Ïø®Îã§Ïö¥ ÌôïÏù∏
    const lastAlert = this.alertCooldowns.get(metricName);
    if (lastAlert && Date.now() - lastAlert < rule.cooldown) {
      return false; // Ïø®Îã§Ïö¥ Ï§ë
    }

    // ÏïåÎ¶º Ï†ÑÏÜ°
    await this.sendAlert(rule.level, metricName, rule.message, {
      value,
      threshold: rule.condition.toString(),
      ...context
    });

    // Ïø®Îã§Ïö¥ ÏÑ§Ï†ï
    this.alertCooldowns.set(metricName, Date.now());
    return true;
  }

  /**
   * ÌÜµÌï© ÏïåÎ¶º Ï†ÑÏÜ°
   */
  async sendAlert(level, title, message, details = {}) {
    const timestamp = new Date().toISOString();
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logger[level === 'critical' ? 'error' : 'warn']('System Alert', {
      type: 'system_alert',
      level,
      title,
      message,
      details,
      timestamp,
    });

    // Slack ÏïåÎ¶º
    await this.slackService.sendAlert(level, title, message, details);

    // ÏπòÎ™ÖÏ†ÅÏù∏ ÏïåÎ¶ºÏùÄ Ïù¥Î©îÏùºÎ°úÎèÑ Ï†ÑÏÜ°
    if (level === 'critical' || level === 'error') {
      await this.emailService.sendCriticalAlert(title, message, details);
    }
  }

  /**
   * Î∞∞Ìè¨ ÏïåÎ¶º
   */
  async notifyDeployment(environment, version, status, details = {}) {
    await this.slackService.sendDeploymentNotification(environment, version, status);
    
    logger.info('Deployment notification sent', {
      type: 'deployment_notification',
      environment,
      version,
      status,
      details,
    });
  }

  /**
   * Ï†ïÍ∏∞ Î©îÌä∏Î¶≠ Î≥¥Í≥†
   */
  async sendPeriodicReport(metrics) {
    await this.slackService.sendMetricsUpdate(metrics);
    
    // Ï£ºÍ∞Ñ Î≥¥Í≥†ÏÑúÎäî Ïù¥Î©îÏùºÎ°ú
    const now = new Date();
    if (now.getDay() === 1 && now.getHours() === 9) { // ÏõîÏöîÏùº 9Ïãú
      await this.emailService.sendWeeklyReport(metrics);
    }
  }

  /**
   * ÏÇ¨Ïö©Ïûê ÌñâÎèô Í∏∞Î∞ò ÏïåÎ¶º
   */
  async notifyUserBehavior(event, data) {
    switch (event) {
      case 'new_user_signup':
        await this.slackService.sendMessage(
          `:wave: New user signed up: ${data.email}`,
          { channel: '#growth' }
        );
        break;
        
      case 'high_engagement':
        await this.slackService.sendMessage(
          `:fire: User ${data.userId} sent ${data.messageCount} messages today!`,
          { channel: '#engagement' }
        );
        break;
        
      case 'feature_adoption':
        await this.slackService.sendMessage(
          `:rocket: Feature "${data.feature}" was used by ${data.userCount} users today`,
          { channel: '#product' }
        );
        break;
    }
  }

  /**
   * Î≥¥Ïïà Ïù¥Î≤§Ìä∏ ÏïåÎ¶º
   */
  async notifySecurityEvent(event, details) {
    await this.sendAlert('critical', `Security Event: ${event}`, 
      'A security event has been detected and requires immediate attention.', 
      details
    );
  }
}

// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§
const notificationManager = new NotificationManager();

module.exports = {
  EmailNotificationService,
  SlackNotificationService,
  NotificationManager,
  notificationManager,
};
